# MediaWiki docker

Задание:
Запустите сервис MediaWiki используя docker на сервере HQ-SRV.

a. Установите Docker и Docker Compose.

b. Создайте в домашней директории пользователя файл wiki.yml для приложения MediaWiki:

    i. Средствами docker compose должен создаваться стек контейнеров с приложением MediaWiki и базой данных

    ii. Используйте два сервиса; 

    iii. Основной контейнер MediaWiki должен называться wiki и использовать образ mediawiki;

    iv. Файл LocalSettings.php с корректными настройками должен находиться в домашней папке пользователя и автоматически монтироваться в образ;

    v. Контейнер с базой данных должен называться db и использовать образ mysql;

    vi. Он должен создавать базу с названием mediawiki, доступную по стандартному порту, для пользователя wiki с паролем DEP@ssw0rd;
    vii. База должна храниться в отдельном volume с названием dbvolume.
    MediaWiki должна быть доступна извне через порт 8080.

## HQ-SRV:
Установка docker и docker-compose:

``` bash
apt-get install -y docker-{ce,compose}
```

Включаем и добавляем в автозагрузку службу docker:

``` bash
systemctl enable --now docker.service
```

В домашней директории пользователя root создаём файл wiki.yml со следующим содержимым:

``` bash
nano ~/wiki.yml
```

>[!NOTE]
>services — основной раздел, где мы будем создавать и описывать наши сервисы (контейнеры docker). В данном примере сервиса два: MediaWiki - для приложения mediawiki и database - для базы данных;
>[!NOTE]
>container_name — имя, которое получит созданный контейнер;
>[!NOTE]
>image — имя образа, который будет использоваться для создания контейнера;
>[!NOTE]
>restart — поведения контейнера при падении;
>[!NOTE]
>ports (внешняя публикация). С помощью данной опции мы можем указывать, на каких портах должен слушать контейнер и на какие порты должны пробрасываться запросы
>[!NOTE]
>environment — задаем переменные окружения;
>[!NOTE]
>volumes - проброс папок;
>[!NOTE]
>links - ссылайтесь на контейнеры в другом сервисе. Укажите либо имя сервиса, либо псевдоним ссылки (SERVICE:ALIAS), либо просто имя сервиса.

**P.S.**
**После первоначальной настройки через Web-интерфейс с CLI загрузите LocalSettings.php в тот же каталог, что и эта wiki.yml и раскомментируйте следующую строку "# - ./LocalSettings.php:/var/www/html/LocalSettings.php" и используйте docker-compose для перезапуска службы mediawiki**

Чтобы отдельный volume для хранения базы данных имел правильное имя - создаём его средствами docker:

``` bash
docker volume create dbvolume
```

Выполняем сборку и запуск стека контейнеров с приложением MediaWiki и базой данных описанных в файле wiki.yml:

``` bash
docker-compose -f wiki.yml up -d
```

## HQ-R:
добавляем проброс порта 8080 при обращение на внешний интерфейс (ens33) на порт 8080 HQ-SRV:

через выбранный брандмауэр на моменте настройки NAT и проброса порта для SSH:

``` bash
nft add rule inet nat prerouting ip daddr 11.11.11.11 tcp dport 8080 dnat ip to 192.168.100.1:8080
```

также не забываем сохранить внесённые изменения в файл **"/etc/nftables/nftables.nft"**

## CLI:

добавляем запись в файл /etc/hosts:
для обращения к MediaWiki по имени, можно также на HQ-SRV в DNS сервере добавить запись типа CNAME для HR-R, за место использования файла /etc/hosts:

``` bash
echo 11.11.11.11 mediawiki.demo.first mediawiki >> /etc/hosts
```

Переходим в браузер http://mediawiki.demo.first:8080 для продолжения установки через веб-интерфейс - нажимаем set up the wiki: